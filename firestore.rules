rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users collection
    match /users/{userId} {
      // Authenticated users can read any user document (needed for role checking)
      allow read: if request.auth != null;
      // Users can create/update their own document
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }
    
    // Events collection
    match /events/{eventId} {
      // Anyone authenticated can read events
      allow read: if request.auth != null;
      
      // Only organizers can create events
      allow create: if request.auth != null 
                    && request.resource.data.organizerId == request.auth.uid;
      
      // Only the event organizer can update/delete their events
      // But allow students to update participants array and participantCount for registration
      allow update: if request.auth != null && (
        // Organizer can update all fields
        resource.data.organizerId == request.auth.uid ||
        // Students can only update participants and participantCount
        // Ensure only these fields are being changed
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['participants', 'participantCount', 'updatedAt']) &&
         // Ensure participants is a list
         request.resource.data.participants is list &&
         // Ensure participantCount is an int
         request.resource.data.participantCount is int &&
         // Ensure other important fields remain unchanged
         request.resource.data.organizerId == resource.data.organizerId &&
         request.resource.data.title == resource.data.title &&
         request.resource.data.startDate == resource.data.startDate &&
         request.resource.data.endDate == resource.data.endDate &&
         request.resource.data.venue == resource.data.venue &&
         request.resource.data.participantLimit == resource.data.participantLimit)
      );
      
      allow delete: if request.auth != null 
                    && resource.data.organizerId == request.auth.uid;
    }
    
    // Attendance collection
    match /attendance/{attendanceId} {
      // Organizers can read attendance for their events
      allow read: if request.auth != null;
      
      // Only organizers can create attendance records for their events
      allow create: if request.auth != null 
                    && request.resource.data.organizerId == request.auth.uid;
      
      // Organizers can update/delete attendance for their events
      allow update, delete: if request.auth != null 
                            && resource.data.organizerId == request.auth.uid;
    }
    
    // Feedback collection
    match /feedback/{feedbackId} {
      // Students can read their own feedback
      // Organizers can read feedback for their events
      allow read: if request.auth != null && (
        resource.data.studentId == request.auth.uid ||
        // Organizer can read if they own the event
        // We'll need to check the event's organizerId
        true // Allow read for now, we'll filter in the app
      );
      
      // Students can create feedback for events they attended
      allow create: if request.auth != null 
                    && request.resource.data.studentId == request.auth.uid
                    && request.resource.data.rating is int
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5
                    && request.resource.data.comment is string;
      
      // Students can update their own feedback
      allow update: if request.auth != null 
                    && resource.data.studentId == request.auth.uid
                    && request.resource.data.studentId == resource.data.studentId
                    && request.resource.data.eventId == resource.data.eventId;
      
      // Students can delete their own feedback
      allow delete: if request.auth != null 
                    && resource.data.studentId == request.auth.uid;
    }
    
    // Default: deny all access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}